rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuth() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    function isParticipant(participants) {
      return isAuth() && request.auth.uid in participants;
    }
    
    function isAdmin() {
      return isAuth() && request.auth.token.admin == true;
    }
    
    // ============================================
    // USERS
    // ============================================
    match /users/{userId} {
      allow read: if isAuth();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || (
        isAuth() && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['friends']) &&
        request.resource.data.friends.hasAll(resource.data.friends) &&
        request.resource.data.friends.size() == resource.data.friends.size() + 1 &&
        request.resource.data.friends.toSet().difference(resource.data.friends.toSet()).hasOnly([request.auth.uid])
      );
      allow delete: if isOwner(userId);
    }
    
    // ============================================
    // PETS
    // ============================================
    match /pets/{petId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuth() && resource.data.ownerId == request.auth.uid;
      allow delete: if isAuth() && resource.data.ownerId == request.auth.uid;
    }
    
    // ============================================
    // POSTS (Community)
    // ============================================
    match /posts/{postId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.authorId == request.auth.uid;
      allow update: if isAuth() && resource.data.authorId == request.auth.uid;
      allow delete: if isAuth() && resource.data.authorId == request.auth.uid;
    }
    
    // ============================================
    // COMMENTS
    // ============================================
    match /comments/{commentId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.authorId == request.auth.uid;
      allow update: if isAuth() && resource.data.authorId == request.auth.uid;
      allow delete: if isAuth() && resource.data.authorId == request.auth.uid;
    }
    
    // ============================================
    // LIKES
    // ============================================
    match /likes/{likeId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
      allow update: if false;
    }
    
    // ============================================
    // CONVERSATIONS
    // ============================================
    match /conversations/{conversationId} {
      allow read: if isAuth() && (
        resource.data.participants == null || 
        isParticipant(resource.data.participants)
      );
      allow create: if isAuth() && isParticipant(request.resource.data.participants);
      allow update: if isAuth() && (
        resource.data.participants == null || 
        isParticipant(resource.data.participants)
      );
      allow delete: if false;
    }
    
    // ============================================
    // MESSAGES
    // ============================================
    match /messages/{messageId} {
      allow read: if isAuth() && (
        resource.data.senderId == request.auth.uid || 
        resource.data.receiverId == request.auth.uid ||
        (resource.data.conversationId != null &&
         exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId)) &&
         request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participants)
      );
      allow create: if isAuth() && request.resource.data.senderId == request.auth.uid;
      allow update: if isAuth() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.receiverId == request.auth.uid
      );
      allow delete: if false;
    }
    
    // ============================================
    // FRIEND REQUESTS
    // ============================================
    match /friendRequests/{requestId} {
      allow read: if isAuth() && (
        resource.data.senderId == request.auth.uid || 
        resource.data.receiverId == request.auth.uid
      );
      allow create: if isAuth() && request.resource.data.senderId == request.auth.uid;
      allow update: if isAuth() && (
        resource.data.receiverId == request.auth.uid || 
        resource.data.senderId == request.auth.uid
      );
      allow delete: if isAuth() && (
        resource.data.senderId == request.auth.uid || 
        resource.data.receiverId == request.auth.uid
      );
    }
    
    // ============================================
    // FAVORITES
    // ============================================
    match /favorites/{favoriteId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
      allow update: if false;
    }
    
    // ============================================
    // PET SITTER PROFILES
    // ============================================
    match /petSitterProfiles/{sitterId} {
      allow read: if isAuth();
      allow create: if isOwner(sitterId) || (isAuth() && request.resource.data.userId == request.auth.uid);
      allow update: if isOwner(sitterId) || (isAuth() && resource.data.userId == request.auth.uid);
      allow delete: if isOwner(sitterId) || (isAuth() && resource.data.userId == request.auth.uid);
    }
    
    // ============================================
    // BOOKINGS
    // ============================================
    match /bookings/{bookingId} {
      allow read: if isAuth() && (
        resource.data.clientId == request.auth.uid || 
        resource.data.catSitterId == request.auth.uid || 
        resource.data.userId == request.auth.uid ||
        resource.data.sitterId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid
      );
      allow create: if isAuth() && (
        request.resource.data.clientId == request.auth.uid || 
        request.resource.data.userId == request.auth.uid ||
        request.resource.data.ownerId == request.auth.uid
      );
      allow update: if isAuth() && (
        resource.data.clientId == request.auth.uid || 
        resource.data.catSitterId == request.auth.uid || 
        resource.data.userId == request.auth.uid ||
        resource.data.sitterId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid
      );
      allow delete: if isAuth() && (
        resource.data.clientId == request.auth.uid || 
        resource.data.userId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid
      );
    }
    
    // ============================================
    // LOST & FOUND REPORTS
    // ============================================
    match /lostFoundReports/{reportId} {
      allow read: if isAuth();
      allow create: if isAuth() && (
        request.resource.data.reporterId == request.auth.uid ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuth() && (
        resource.data.reporterId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuth() && (
        resource.data.reporterId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // ============================================
    // CHALLENGES
    // ============================================
    match /challenges/{challengeId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    // ============================================
    // USER CHALLENGES
    // ============================================
    match /userChallenges/{userChallengeId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // CHALLENGE PARTICIPATIONS
    // ============================================
    match /challengeParticipations/{participationId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // CHALLENGE SUBMISSIONS
    // ============================================
    match /challengeSubmissions/{submissionId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth();
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // PRODUCTS
    // ============================================
    match /products/{productId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    // ============================================
    // PROFESSIONAL PRODUCTS
    // ============================================
    match /professionalProducts/{productId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isAuth() && resource.data.sellerId == request.auth.uid;
      allow delete: if isAuth() && resource.data.sellerId == request.auth.uid;
    }
    
    // ============================================
    // ORDERS
    // ============================================
    match /orders/{orderId} {
      allow read: if isAuth() && (
        resource.data.customerId == request.auth.uid || 
        resource.data.sellerId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuth() && (
        request.resource.data.customerId == request.auth.uid ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuth() && (
        resource.data.sellerId == request.auth.uid ||
        resource.data.customerId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if false;
    }
    
    // ============================================
    // HEALTH RECORDS
    // ============================================
    match /healthRecords/{recordId} {
      allow read: if isAuth() && (
        resource.data.petOwnerId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuth() && (
        request.resource.data.petOwnerId == request.auth.uid ||
        request.resource.data.ownerId == request.auth.uid ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuth() && (
        resource.data.petOwnerId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuth() && (
        resource.data.petOwnerId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // ============================================
    // VACCINATIONS
    // ============================================
    match /vaccinations/{vaccinationId} {
      allow read: if isAuth() && (
        resource.data.petOwnerId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isAuth() && (
        request.resource.data.petOwnerId == request.auth.uid ||
        request.resource.data.ownerId == request.auth.uid ||
        request.resource.data.userId == request.auth.uid
      );
      allow update: if isAuth() && (
        resource.data.petOwnerId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isAuth() && (
        resource.data.petOwnerId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
    }
    
    // ============================================
    // NOTIFICATIONS
    // ============================================
    match /notifications/{notificationId} {
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow create: if isAuth();
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // REVIEWS
    // ============================================
    match /reviews/{reviewId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.authorId == request.auth.uid;
      allow update: if isAuth() && resource.data.authorId == request.auth.uid;
      allow delete: if isAuth() && resource.data.authorId == request.auth.uid;
    }
    
    // ============================================
    // PROFESSIONALS
    // ============================================
    match /professionals/{professionalId} {
      allow read: if isAuth();
      allow create: if isOwner(professionalId) || (isAuth() && request.resource.data.userId == request.auth.uid);
      allow update: if isOwner(professionalId) || (isAuth() && resource.data.userId == request.auth.uid);
      allow delete: if isOwner(professionalId) || (isAuth() && resource.data.userId == request.auth.uid);
    }
    
    // ============================================
    // BADGES
    // ============================================
    match /badges/{badgeId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    // ============================================
    // USER BADGES
    // ============================================
    match /userBadges/{userBadgeId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // PET MATCHING
    // ============================================
    match /petLikes/{likeId} {
      allow read: if isAuth() && (
        resource.data.userId == request.auth.uid ||
        resource.data.targetOwnerId == request.auth.uid
      );
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
      allow update: if false;
    }
    
    match /petMatches/{matchId} {
      allow read: if isAuth() && (
        resource.data.userId == request.auth.uid ||
        resource.data.matchedUserId == request.auth.uid ||
        resource.data.user1Id == request.auth.uid ||
        resource.data.user2Id == request.auth.uid
      );
      allow create: if isAuth() && (
        request.resource.data.userId == request.auth.uid ||
        request.resource.data.user1Id == request.auth.uid
      );
      allow update: if isAuth() && (
        resource.data.userId == request.auth.uid ||
        resource.data.matchedUserId == request.auth.uid ||
        resource.data.user1Id == request.auth.uid ||
        resource.data.user2Id == request.auth.uid
      );
      allow delete: if isAuth() && (
        resource.data.userId == request.auth.uid ||
        resource.data.user1Id == request.auth.uid
      );
    }
    
    match /petPasses/{passId} {
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // REPORTS & MODERATION
    // ============================================
    match /reports/{reportId} {
      allow read: if isAuth() && resource.data.reporterId == request.auth.uid;
      allow create: if isAuth() && request.resource.data.reporterId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }
    
    match /moderationActions/{actionId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    match /userFlags/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isAdmin();
    }
    
    match /moderationQueue/{itemId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // ============================================
    // PROFESSIONAL VERIFICATIONS
    // ============================================
    match /professionalVerifications/{verificationId} {
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // BLOCKED USERS
    // ============================================
    match /blockedUsers/{blockId} {
      allow read: if isAuth() && resource.data.blockerId == request.auth.uid;
      allow create: if isAuth() && request.resource.data.blockerId == request.auth.uid;
      allow delete: if isAuth() && resource.data.blockerId == request.auth.uid;
      allow update: if false;
    }
    
    // ============================================
    // EMERGENCY CONTACTS
    // ============================================
    match /emergencyContacts/{contactId} {
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // REFERENCE DATA (Read-only)
    // ============================================
    match /animalSpecies/{speciesId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    match /animalBreeds/{breedId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    // ============================================
    // AI LOGS & CONFIG
    // ============================================
    match /ai_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuth();
      allow update: if false;
      allow delete: if false;
    }
    
    match /config/{configId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    // ============================================
    // PROMO SUBMISSIONS
    // ============================================
    match /promoSubmissions/{submissionId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // VET BOOKINGS
    // ============================================
    match /vetBookings/{bookingId} {
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // VET SESSIONS (AI Assistant)
    // ============================================
    match /vetSessions/{sessionId} {
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // CART (Shopping)
    // ============================================
    match /carts/{cartId} {
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // SUBSCRIPTIONS
    // ============================================
    match /subscriptions/{subscriptionId} {
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    // Catch-all: deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
