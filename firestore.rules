rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuth() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    function isParticipant(participants) {
      return isAuth() && request.auth.uid in participants;
    }
    
    // Check if a field is being modified (for immutable fields)
    function fieldUnchanged(field) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny([field]);
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuth();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }
    
    // Pets collection
    match /pets/{petId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuth() && resource.data.ownerId == request.auth.uid && fieldUnchanged('ownerId');
      allow delete: if isAuth() && resource.data.ownerId == request.auth.uid;
    }
    
    // Posts collection
    match /posts/{postId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.authorId == request.auth.uid;
      allow update: if isAuth() && resource.data.authorId == request.auth.uid && fieldUnchanged('authorId');
      allow delete: if isAuth() && resource.data.authorId == request.auth.uid;
    }
    
    // Comments collection
    match /comments/{commentId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.authorId == request.auth.uid;
      allow update: if isAuth() && resource.data.authorId == request.auth.uid && fieldUnchanged('authorId');
      allow delete: if isAuth() && resource.data.authorId == request.auth.uid;
    }
    
    // Likes collection (immutable after creation)
    match /likes/{likeId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
      allow update: if false;
    }
    
    // Conversations collection
    match /conversations/{conversationId} {
      allow read: if isAuth() && isParticipant(resource.data.participants);
      allow create: if isAuth() && isParticipant(request.resource.data.participants);
      allow update: if isAuth() && isParticipant(resource.data.participants);
      allow delete: if false;
    }
    
    // Messages collection
    match /messages/{messageId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.senderId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }
    
    // Friend Requests collection (idempotent docId: minUid_maxUid)
    match /friendRequests/{requestId} {
      allow read: if isAuth() && (resource.data.senderId == request.auth.uid || resource.data.receiverId == request.auth.uid);
      allow create: if isAuth() && request.resource.data.senderId == request.auth.uid;
      allow update: if isAuth() && (resource.data.receiverId == request.auth.uid || resource.data.senderId == request.auth.uid);
      allow delete: if isAuth() && (resource.data.senderId == request.auth.uid || resource.data.receiverId == request.auth.uid);
    }
    
    // Pet Sitter Profiles collection
    match /petSitterProfiles/{sitterId} {
      allow read: if isAuth();
      allow create: if isOwner(sitterId);
      allow update: if isOwner(sitterId);
      allow delete: if isOwner(sitterId);
    }
    
    // Bookings collection
    match /bookings/{bookingId} {
      allow read: if isAuth() && (resource.data.clientId == request.auth.uid || resource.data.catSitterId == request.auth.uid);
      allow create: if isAuth() && request.resource.data.clientId == request.auth.uid;
      allow update: if isAuth() && (resource.data.clientId == request.auth.uid || resource.data.catSitterId == request.auth.uid);
      allow delete: if isAuth() && resource.data.clientId == request.auth.uid;
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.authorId == request.auth.uid;
      allow update: if isAuth() && resource.data.authorId == request.auth.uid && fieldUnchanged('authorId');
      allow delete: if false;
    }
    
    // Lost & Found Reports collection
    match /lostFoundReports/{reportId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.reporterId == request.auth.uid;
      allow update: if isAuth() && resource.data.reporterId == request.auth.uid;
      allow delete: if isAuth() && resource.data.reporterId == request.auth.uid;
    }
    
    // Professionals collection
    match /professionals/{professionalId} {
      allow read: if isAuth();
      allow create: if isOwner(professionalId);
      allow update: if isOwner(professionalId);
      allow delete: if false;
    }
    
    // Products collection (admin only write)
    match /products/{productId} {
      allow read: if isAuth();
      allow write: if false;
    }
    
    // Professional Products collection
    match /professionalProducts/{productId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isAuth() && resource.data.sellerId == request.auth.uid;
      allow delete: if isAuth() && resource.data.sellerId == request.auth.uid;
    }
    
    // Orders collection
    match /orders/{orderId} {
      allow read: if isAuth() && (resource.data.customerId == request.auth.uid || resource.data.sellerId == request.auth.uid);
      allow create: if isAuth() && request.resource.data.customerId == request.auth.uid;
      allow update: if isAuth() && resource.data.sellerId == request.auth.uid;
      allow delete: if false;
    }
    
    // Challenges collection (admin only write)
    match /challenges/{challengeId} {
      allow read: if isAuth();
      allow write: if false;
    }
    
    // User Challenges collection
    match /userChallenges/{userChallengeId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth();
      allow delete: if false;
    }
    
    // Challenge Participations collection
    match /challengeParticipations/{participationId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth();
      allow delete: if false;
    }
    
    // Challenge Submissions collection
    match /challengeSubmissions/{submissionId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update: if isAuth();
      allow delete: if false;
    }
    
    // Badges collection (admin only write)
    match /badges/{badgeId} {
      allow read: if isAuth();
      allow write: if false;
    }
    
    // User Badges collection
    match /userBadges/{userBadgeId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow create: if false;
      allow delete: if false;
    }
    
    // Favorites collection
    match /favorites/{favoriteId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
      allow update: if false;
    }
    
    // Reports collection (moderation)
    match /reports/{reportId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.reporterId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }
    
    // Blocked Users collection
    match /blockedUsers/{blockId} {
      allow read: if isAuth() && resource.data.blockerId == request.auth.uid;
      allow create: if isAuth() && request.resource.data.blockerId == request.auth.uid;
      allow delete: if isAuth() && resource.data.blockerId == request.auth.uid;
      allow update: if false;
    }
    
    // Pet Matching collections
    match /petLikes/{likeId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow delete: if isAuth();
      allow update: if false;
    }
    
    match /petMatches/{matchId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update: if isAuth();
      allow delete: if isAuth();
    }
    
    match /petPasses/{passId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update: if false;
      allow delete: if false;
    }
    
    // Health Records collections
    match /healthRecords/{recordId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update: if isAuth();
      allow delete: if isAuth();
    }
    
    match /vaccinations/{vaccinationId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update: if isAuth();
      allow delete: if isAuth();
    }
    
    // Emergency Contacts collection
    match /emergencyContacts/{contactId} {
      allow read: if isAuth() && resource.data.userId == request.auth.uid;
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuth() && resource.data.userId == request.auth.uid;
      allow delete: if isAuth() && resource.data.userId == request.auth.uid;
    }
    
    // Animal Species and Breeds (read-only for users)
    match /animalSpecies/{speciesId} {
      allow read: if isAuth();
      allow write: if false;
    }
    
    match /animalBreeds/{breedId} {
      allow read: if isAuth();
      allow write: if false;
    }
    
    // Promo Submissions
    match /promoSubmissions/{submissionId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update: if false;
      allow delete: if false;
    }
    
    // Deny all other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
